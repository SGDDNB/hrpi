---
title: | 
  | Script for analysing bulk ATAC-seq of reprogramming intermediate
author: |
  | Fernando J. Rossello
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: 
      collapsed: false
fontsize: 12pt
pagetitle: "bkATAC"
---

# Preamble
## Things to note
- All input files can be downloaded from http://hrpi.ddnetbio.com/
- All input files are assumed to be in the data folder.
- For reproducibility purposes, the randomisation seed used throughout the manuscript was saved as an object and it should be loaded in all relevant sections (object loaded in code section).
- All genome browser tracks can be explored at http://hrpi.ddnetbio.com at the _bulk ATAC-seq iPSC reprog. section_.

## Load required libraries.

```{r session_setup, include = TRUE, echo=TRUE, results='hide', message=FALSE, warning=FALSE}
library(dplyr)
library(edgeR)
library(irlba)
library(sjstats)
library(Mfuzz)
library(patchwork)
library(data.table)
library(ggplot2)
library(ggrepel)
library(knitr)
# rm(list=ls())
```
## Define colour palettes.

```{r color_labels}

colorMedia = c("black","darkorange","blue","darkolivegreen2","red2","pink2")
names(colorMedia) = c("D0, 3, 7","Primed","t2iLGoY","5iLAF","NHSM","RSeT")
shapeTime = c(0,1,2,15,16,17,18)
names(shapeTime) = c("D0","D3","D7","D13","D21","P3","P10")

gplot.theme <- theme(panel.border=element_blank(), 
        panel.background=element_blank(),
        axis.line=element_line(),
        axis.line.y=element_line("black", size=1),
        axis.line.x=element_line("black", size=1),
        axis.text=(element_text(colour="black", size = 6, face="bold")),
        axis.title=(element_text(colour="black", size = 8, face="bold")),
        axis.ticks = (element_line("black", size=0.5)),
        legend.title = element_text(colour="black", size = 9, face="bold"),
        legend.text = element_text(colour="black", size= 8, face="bold"),
        legend.key.size=unit(0.1,"cm"),
        # legend.margin = unit(0, "cm"),
        legend.position="none",
        plot.margin=unit(c(0,2,0,0),"mm"),
        strip.text.x = element_text(size = 6, colour = "black", face = "bold", margin = margin(0,0,0,0, "cm"))
  )
```

# Exploratory Analysis - PCA.
## Import read counts of consensus peak set.
```{r import_read_counts}
setwd("~/projects/Polo_Group/Ethan_Liu/Ethan_Liu_ATAC-seq_Human_Reprogramming_human_samples/analysis/R/scripts/github")
peak.counts <-
  read.table(file = "data/bkATAC_consensus_peak_set_counts.txt",
             header = T,
             stringsAsFactors = F)
```

### Reorder samples and save peak information.
```{r reorder_samples}
order <- colnames(peak.counts)[7:ncol(peak.counts)]
order <- order[c(1, 2, 11:14, 3, 5, 7, 9, 19, 21, 15, 17, 4, 6, 8, 10, 20, 22, 16, 18)]
order <- factor(order, levels = order)

peak.info <- colnames(peak.counts)[1:6]
```

### Reorder peak counts table.

```{r prepare_counts_table}

peak.counts <- peak.counts[, c(peak.info, levels(order))]

# Change Geneid column name to PeakID

colnames(peak.counts)[1] <- "PeakID"
rownames(peak.counts) <- peak.counts$PeakID
```

## Within and between library normalization.

### Quantile normalise log2(RPKM + 1)

```{r quantile_log2}

peaks.fpkm <-
  rpkm(peak.counts[, 7:ncol(peak.counts)],
       log = F, gene.length = peak.counts$Length)

# Keep peaks with more than 5 FPKMs in at least 2 samples for exploratory analysis.

keep <- rowSums(peaks.fpkm > 5) >= 2

peaks.fpkm <- peaks.fpkm[keep, ]
peaks.fpkm <- log2(peaks.fpkm + 1)
peaks.fpkm <- normalizeQuantiles(peaks.fpkm)
```

## PCA 

```{r pca}
# Prepare annotation table.
pca.plot.annotation <- data.table(sample_id = colnames(peaks.fpkm))

pca.plot.annotation$sample_labels <- c(
  paste(rep("FM_", 3), rep("D", 3), rep(c(0, 3, 7), each = 2), rep(c("_R1", "_R2")), sep = ""),
  paste(rep("PM_", 2), rep("D", 2), rep(c(13, 21), each = 2), rep(c("_R1", "_R2")), sep = ""),
  paste(rep("PM_", 2), rep("P", 2), rep(c(3, 10), each = 2), rep(c("_R1", "_R2")), sep = ""),
  paste(rep("NM_", 2), rep("D", 2), rep(c(13, 21), each = 2), rep(c("_R1", "_R2")), sep = ""),
  paste(rep("NM_", 2), rep("P", 2), rep(c(3, 10), each = 2), rep(c("_R1", "_R2")), sep = "")
)

pca.plot.annotation$media = "D0, 3, 7"
pca.plot.annotation[grep("PM", sample_labels)]$media = "Primed"
pca.plot.annotation[grep("NM", sample_labels)]$media = "t2iLGoY"
pca.plot.annotation$media = factor(pca.plot.annotation$media, 
                           levels = c("D0, 3, 7", "Primed", "t2iLGoY"))
pca.plot.annotation$timept = tstrsplit(pca.plot.annotation$sample_labels, "_")[[2]]
pca.plot.annotation$timept = factor(pca.plot.annotation$timept, 
                            levels = unique(pca.plot.annotation$timept))

load("../data/seed.Rdata")
.Random.seed <- seed
pca <- prcomp_irlba(t(peaks.fpkm))

pca.plot.annotation$PC1 = pca$x[,1]
pca.plot.annotation$PC2 = pca$x[,2]
pca.plot.annotation$PC3 = pca$x[,3]

ggplot(pca.plot.annotation, aes(PC1, PC2, color = media, label = timept)) +
  geom_point(size = 3) + geom_text_repel(size = 5) +
  scale_color_manual(values = colorMedia[1:3]) +
  scale_shape_manual(values = c(16, 15)) + theme_classic(base_size = 24)
  
ggplot(pca.plot.annotation, aes(PC1, PC3, color = media, label = timept)) +
  geom_point(size = 3) + geom_text_repel(size = 5) +
  scale_color_manual(values = colorMedia[1:3]) +
  scale_shape_manual(values = c(16, 15)) + theme_classic(base_size = 24)


```

# Fuzzy clustering.

## Aggregate sample counts means and calculate RPKM.

```{r aggregate_sample_counts_rpkm}
# Prepare conditions labels.

conditions.labels <-
  c(
  "D0",
  "D3",
  "D7",
  "D13.*Primed",
  "D21.*Primed",
  "P3.*Primed",
  "P10.*Primed",
  "D13.*Smith",
  "D21.*Smith",
  "P3.*Smith",
  "P10.*Smith"
  )

# Aggregate peak counts.
aggregated.peak.counts <-
  sapply(conditions.labels, function(x)
    rowSums(peak.counts[, grep(x,
                               colnames(peak.counts),
                               value = TRUE)]))

colnames(aggregated.peak.counts) <-
  colnames(aggregated.peak.counts) %>% gsub("\\.\\*", "_", .)

```
## Quantile normalise log2(RPKM + 1)

```{r aggregated_counts_fpkm_log2}

aggregated.peak.fpkm <-
  rpkm(aggregated.peak.counts,
       log = F,
       gene.length = peak.counts$Length)

# Keep peaks with more than 10 FPKMs in any condition.

aggregated.keep <- rowSums(aggregated.peak.fpkm > 10) >= 1

aggregated.peak.fpkm <- aggregated.peak.fpkm[aggregated.keep, ]
aggregated.peak.fpkm <- log2(aggregated.peak.fpkm + 1)
aggregated.peak.fpkm <- normalizeQuantiles(aggregated.peak.fpkm)

```

## Discard low coefficient of variation peaks.

```{r cv_20_peaks}
cv.20 <- apply(aggregated.peak.fpkm, 1, function(x) cv(x) * 100) > 20
cv.20 %>% table()

aggregated.peak.fpkm.high.cv <- aggregated.peak.fpkm[cv.20, ]

```

## Run fuzzy clustering.

```{r fuzzy_clustering}

exprSet <- ExpressionSet(assayData = aggregated.peak.fpkm.high.cv)

s.exprSet <- standardise(exprSet)

m <- mestimate(s.exprSet)
# Create seed as save it as an object.
# set.seed(1234)
# seed <- .Random.seed
# save(seed, file = "../data/seed.Rdata")

load("../data/seed.Rdata")
.Random.seed <- seed

cl.s.exprSet <- mfuzz(s.exprSet, c = 8, m = m)


# Retrieve peak cluster membership

peak.cluster.membership <- as.data.frame(cl.s.exprSet$cluster) %>% 
  dplyr::mutate(PeakID = rownames(.))
colnames(peak.cluster.membership)[1] <- "Cluster"

```
### Filter high affinity peaks.

```{r core_peaks}

core.exprSet <- acore(s.exprSet,
                      cl = cl.s.exprSet,
                      min.acore = 0.8)

# Peak ids of high affinity peaks
core.exprSet.peaks.id <- sapply(c(1:8), function(x) as.vector(core.exprSet[[x]]$NAME)
)
core.exprSet.peaks.id <- as.character(unlist(core.exprSet.peaks.id))

```

## Create a table of high cluster affinity peaks.
It contains z-scores and peak details.
Please note that for the benefit of biological flow clusters have been relabeled as follows and has been indicated as Cluster_Labels accross the manuscript, source data and supplementary tables.
1 = "C 1", 2 = "C 2", 3 = "C 7", 4 = "C 4", 5 = "C 3", 6 = "C 6", 7 = "C 5", 8 = "C 8".

```{r high_affinity_peaks_z-s}

# Peak z-scores

peak.z.scores <- as.data.frame(s.exprSet@assayData$exprs) %>% 
  dplyr::mutate(., PeakID = rownames(.))

# Table of high affinity peaks annotated.
high.affinity.peaks.annotated <- dplyr::left_join(peak.z.scores,
                                                  peak.cluster.membership,
                                                  by = "PeakID") %>%
  dplyr::left_join(peak.counts[, 1:6], by = "PeakID") %>%
  dplyr::filter(PeakID %in% core.exprSet.peaks.id)

high.affinity.peaks.annotated <-
  high.affinity.peaks.annotated %>% mutate(
  Cluster_Label = case_when(
  Cluster == "1" ~ "C 1",
  Cluster == "2" ~ "C 2",
  Cluster == "3" ~ "C 7",
  Cluster == "4" ~ "C 4",
  Cluster == "5" ~ "C 3",
  Cluster == "6" ~ "C 6",
  Cluster == "7" ~ "C 5",
  TRUE ~ "C 8"
  )
  )
  
```

## Cluster dynamics (mean +/- SD).

### High affinity cluster membership counts table.
```{r membership_counts}

core.exprSet.cluster.counts <- lapply(core.exprSet, nrow) %>%
  unlist() %>% as.data.frame() %>% 
  mutate(Cluster = c(1:8))

colnames(core.exprSet.cluster.counts)[1] <- "members"

core.exprSet.cluster.counts <-
  core.exprSet.cluster.counts %>% mutate(
  Cluster_Label = case_when(
  Cluster == "1" ~ "C 1",
  Cluster == "2" ~ "C 2",
  Cluster == "3" ~ "C 7",
  Cluster == "4" ~ "C 4",
  Cluster == "5" ~ "C 3",
  Cluster == "6" ~ "C 6",
  Cluster == "7" ~ "C 5",
  TRUE ~ "C 8"
  )
  )
  
core.exprSet.cluster.counts$Cluster_Label <- factor(x = core.exprSet.cluster.counts$Cluster_Label,
                                                    levels = paste("C", 1:8, sep = " "))
knitr::kable(core.exprSet.cluster.counts %>% select(Cluster_Label, members) %>% arrange(Cluster_Label))
```

## Cluster dynamics plots.

### Prepare table.

```{r  cluster_dynamics_table}
high.affinity.peaks.melt <-
  melt(select(
  high.affinity.peaks.annotated,
  -c("Chr", "Start", "End", "Strand", "Length", "Cluster_Label")
  ),
  id = c("PeakID", "Cluster"))

# Define stage and media

high.affinity.peaks.melt <-
  high.affinity.peaks.melt %>% mutate(stage = case_when(
  grepl("D13", variable) ~ "D13",
  grepl("D21", variable) ~ "D21",
  grepl("P3", variable) ~ "P3",
  grepl("P10", variable) ~ "P10",
  TRUE ~ as.character(variable)
  )) %>%
  mutate(media = case_when(
  grepl("D0|D3|D7", variable) ~ "FM",
  grepl("Smith", variable) ~ "NM",
  grepl("Primed", variable) ~ "PM"
  ))
  
# Order Stages                                                          
high.affinity.peaks.melt$stage <-
  factor(high.affinity.peaks.melt$stage,
  levels = c("D0", "D3", "D7", "D13", "D21", "P3", "P10"))
  
# Order Clusters
high.affinity.peaks.melt$Cluster <-
  factor(high.affinity.peaks.melt$Cluster, levels = c(1, 2, 5, 4, 7, 6, 3, 8))



cluster.dynamics.plot.values <-
  high.affinity.peaks.melt %>% group_by(media, stage, Cluster) %>% summarise(
  mean = mean(value),
  sd = sd(value)
  )
  
# Define Cluster labels (please see comment above)

cluster.dynamics.plot.values <-
  cluster.dynamics.plot.values %>% mutate(
  Cluster_Label = case_when(
  Cluster == "1" ~ "C 1",
  Cluster == "2" ~ "C 2",
  Cluster == "3" ~ "C 7",
  Cluster == "4" ~ "C 4",
  Cluster == "5" ~ "C 3",
  Cluster == "6" ~ "C 6",
  Cluster == "7" ~ "C 5",
  TRUE ~ "C 8"
  )
  )

cluster.dynamics.plot.values$Cluster_Label  <-
  factor(
  x = cluster.dynamics.plot.values$Cluster_Label,
  levels = c("C 1", "C 2", "C 3", "C 4", "C 5", "C 6", "C 7", "C 8")
  )


```
### Cluster dynamics plot.
Ribbon equals mean +/- SD.
```{r cluster_dynamics_plot}

ggplot(data = NULL, aes(stage, mean, group = 1)) +
  geom_line(data = dplyr::filter(cluster.dynamics.plot.values, media %in% c("FM", "PM")), color = "#FF8C00", size = 0.5) +
  geom_line(data = dplyr::filter(cluster.dynamics.plot.values, media %in% c("FM", "PM"), stage %in% c("D0", "D3", "D7")), color = "black", size = 0.5) +
  geom_ribbon(data = dplyr::filter(cluster.dynamics.plot.values, media %in% c("FM", "PM"), stage %in% c("D0", "D3", "D7")),
              aes(x = stage, ymax = mean + sd, ymin = mean - sd), fill = "black", alpha = 0.5) +
  geom_ribbon(data = dplyr::filter(cluster.dynamics.plot.values, media %in% c("FM", "PM"), stage %in% c("D7","D13", "D21", "P3", "P10")),
              aes(x = stage, ymax = mean + sd, ymin = mean - sd), fill = "#FF8C00", alpha = 0.5) +
  geom_line(data = dplyr::filter(cluster.dynamics.plot.values, media %in% c("FM", "NM")), color = "#2302FE", size = 0.5) +
  geom_line(data = dplyr::filter(cluster.dynamics.plot.values, media %in% c("FM", "NM"), stage %in% c("D7", "D13", "D21", "P3", "P10")), color = "#2302FE", size = 0.5) +
  geom_line(data = dplyr::filter(cluster.dynamics.plot.values, media %in% c("FM", "NM"), stage %in% c("D0", "D3", "D7")), color = "black", size = 0.5) +
    geom_ribbon(data = dplyr::filter(cluster.dynamics.plot.values, media %in% c("FM", "NM"), stage %in% c("D0", "D3", "D7")),
              aes(x = stage, ymax = mean + sd, ymin = mean - sd), fill = "black", alpha = 0.5) +
  geom_ribbon(data = dplyr::filter(cluster.dynamics.plot.values, media %in% c("FM","NM"), stage %in% c("D7","D13", "D21", "P3", "P10")),
              aes(x = stage, ymax = mean + sd, ymin = mean - sd), fill = "#2302FE", alpha = 0.5) +
  facet_wrap(~ Cluster_Label, nrow = 4, ncol = 2) +
  gplot.theme + theme(legend.position = "none", axis.title = element_blank())

```

